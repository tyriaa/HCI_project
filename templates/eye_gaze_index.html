<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eye Gaze Detection - Screen Focus Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
        }
        
        .video-container {
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        
        .status-badge {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .flag-alert {
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .looking-good {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .looking-away {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .no-face {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .flag-item {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
</head>
<body class="text-white">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-2">
                <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">
                    üëÅÔ∏è Eye Gaze Detection
                </span>
            </h1>
            <p class="text-gray-400">Real-time screen focus monitoring</p>
        </header>
        
        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Video Feed -->
            <div class="lg:col-span-2">
                <div class="video-container">
                    <img id="video-feed" src="/video_feed" alt="Video Feed" 
                         class="w-full rounded-2xl">
                    
                    <!-- Overlay Status -->
                    <div id="overlay-status" class="absolute top-4 left-4 px-4 py-2 rounded-full text-white font-semibold status-badge looking-good">
                        <span id="status-icon">‚úÖ</span>
                        <span id="status-text">Initializing...</span>
                    </div>
                </div>
                
                <!-- Instructions -->
                <div class="glass-card rounded-xl p-4 mt-4">
                    <h3 class="font-semibold text-lg mb-2">üìã Instructions</h3>
                    <ul class="text-gray-300 text-sm space-y-1">
                        <li>‚Ä¢ Keep your face visible in the camera</li>
                        <li>‚Ä¢ Look directly at the screen to avoid flags</li>
                        <li>‚Ä¢ Looking away for more than 1.5 seconds will trigger a flag</li>
                        <li>‚Ä¢ Head movements and eye gaze are both tracked</li>
                    </ul>
                </div>
            </div>
            
            <!-- Stats Panel -->
            <div class="space-y-4">
                <!-- Current Status Card -->
                <div class="glass-card rounded-xl p-6">
                    <h3 class="font-semibold text-lg mb-4">üìä Current Status</h3>
                    
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Direction:</span>
                            <span id="direction" class="font-medium">-</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Looking Away:</span>
                            <span id="looking-away-duration" class="font-medium">0.0s</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">üì± Phone:</span>
                            <span id="phone-status" class="font-medium">-</span>
                        </div>
                        
                        <div class="border-t border-gray-600 my-3"></div>
                        <h4 class="text-sm font-semibold text-cyan-400 mb-2">üëÅÔ∏è Eye Tracking</h4>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Eye Openness:</span>
                            <span id="eye-openness" class="font-medium text-cyan-400">100%</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Blink Count:</span>
                            <span id="blink-count" class="font-medium text-cyan-400">0</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Iris Position:</span>
                            <span id="iris-position" class="font-medium text-cyan-400">Center</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Head Roll:</span>
                            <span id="head-roll" class="font-medium text-cyan-400">0¬∞</span>
                        </div>
                        
                        <div class="border-t border-gray-600 my-3"></div>
                        <h4 class="text-sm font-semibold text-purple-400 mb-2">üéØ Attention Monitoring</h4>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Attention Score:</span>
                            <span id="attention-score" class="font-bold text-lg text-purple-400">100%</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Status:</span>
                            <span id="attention-status" class="font-medium text-green-400">Attentive</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Facing Camera:</span>
                            <span id="facing-score" class="font-medium text-purple-400">100%</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Occlusion:</span>
                            <span id="occlusion-status" class="font-medium text-green-400">None</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Mouth Activity:</span>
                            <span id="mouth-activity" class="font-medium text-purple-400">0%</span>
                        </div>
                        
                        <div class="border-t border-gray-600 my-3"></div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Total Flags:</span>
                            <span id="total-flags" class="font-bold text-2xl text-red-400">0</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Phone Flags:</span>
                            <span id="phone-flags" class="font-bold text-orange-400">0</span>
                        </div>
                        
                        <div class="border-t border-gray-600 my-3"></div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">üîÑ Tab Switches:</span>
                            <span id="tab-switches" class="font-medium text-yellow-400">0</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">ü™ü Window Blurs:</span>
                            <span id="window-blurs" class="font-medium text-yellow-400">0</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Tab Status:</span>
                            <span id="tab-status" class="font-medium text-green-400">‚úÖ Visible</span>
                        </div>
                        
                        <div class="border-t border-gray-600 my-3"></div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">‚úã Hands Detected:</span>
                            <span id="hands-detected" class="font-medium text-blue-400">0</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Left Hand:</span>
                            <span id="left-hand-status" class="font-medium text-gray-400">‚ùå</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Right Hand:</span>
                            <span id="right-hand-status" class="font-medium text-gray-400">‚ùå</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Gesture:</span>
                            <span id="hand-gesture" class="font-medium text-cyan-400">none</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Holding Object:</span>
                            <span id="holding-object" class="font-medium text-green-400">‚ùå No</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Hand Flags:</span>
                            <span id="hand-flags" class="font-bold text-purple-400">0</span>
                        </div>
                        
                        <div class="border-t border-gray-600 my-3"></div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">‚ö†Ô∏è Behaviors:</span>
                            <span id="suspicious-behaviors" class="font-medium text-orange-400">None</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Behavior Flags:</span>
                            <span id="behavior-flags" class="font-bold text-orange-400">0</span>
                        </div>
                    </div>
                </div>
                
                <!-- Flag Counter -->
                <div id="flag-counter" class="glass-card rounded-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold text-lg">üö© Flag History</h3>
                        <button onclick="resetFlags()" 
                                class="px-3 py-1 bg-red-500 hover:bg-red-600 rounded-lg text-sm transition-colors">
                            Reset
                        </button>
                    </div>
                    
                    <div id="flag-list" class="space-y-2 max-h-64 overflow-y-auto">
                        <p class="text-gray-500 text-sm">No flags yet. Keep looking at the screen!</p>
                    </div>
                </div>
                
                <!-- Calibration Card -->
                <div class="glass-card rounded-xl p-6">
                    <h3 class="font-semibold text-lg mb-3">üéØ Calibration</h3>
                    <p class="text-gray-300 text-sm mb-3">
                        Si la d√©tection est incorrecte, recalibrez en regardant l'√©cran normalement.
                    </p>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-400 text-sm">Pitch offset:</span>
                        <span id="pitch-offset" class="font-mono text-sm">0.0¬∞</span>
                    </div>
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-gray-400 text-sm">Status:</span>
                        <span id="calibration-status" class="text-sm">-</span>
                    </div>
                    <button onclick="recalibrate()" 
                            class="w-full px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg text-sm transition-colors font-medium">
                        üîÑ Recalibrer
                    </button>
                </div>
                
                <!-- Tips Card -->
                <div class="glass-card rounded-xl p-6">
                    <h3 class="font-semibold text-lg mb-3">üí° Tips</h3>
                    <ul class="text-gray-300 text-sm space-y-2">
                        <li>üîÜ Ensure good lighting on your face</li>
                        <li>üìè Sit at a comfortable distance</li>
                        <li>üéØ Position camera at eye level</li>
                        <li>üëì Remove glasses if causing issues</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Alert Sound (optional) -->
    <audio id="alert-sound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleQAA" type="audio/wav">
    </audio>
    
    <script>
        let lastFlagCount = 0;
        let previousFlags = [];
        let tabSwitchCount = 0;
        let windowBlurCount = 0;
        let isTabVisible = true;
        let tabSwitchStartTime = null;
        
        // Update status periodically
        function updateStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    // Update direction with emoji
                    const directionEl = document.getElementById('direction');
                    let dirText = data.direction || '-';
                    let emoji = '';
                    
                    if (dirText.includes('LEFT')) emoji = 'üëà ';
                    else if (dirText.includes('RIGHT')) emoji = 'üëâ ';
                    else if (dirText.includes('UP')) emoji = 'üëÜ ';
                    else if (dirText.includes('DOWN')) emoji = 'üëá ';
                    else if (dirText.includes('screen')) emoji = '‚úÖ ';
                    
                    directionEl.textContent = emoji + dirText;
                    
                    // Color based on looking at screen or not
                    if (dirText.includes('screen')) {
                        directionEl.classList.add('text-green-400');
                        directionEl.classList.remove('text-red-400', 'text-yellow-400');
                    } else {
                        directionEl.classList.add('text-red-400');
                        directionEl.classList.remove('text-green-400', 'text-yellow-400');
                    }
                    
                    // Update looking away duration
                    const duration = data.looking_away_duration || 0;
                    document.getElementById('looking-away-duration').textContent = duration.toFixed(1) + 's';
                    
                    // Update total flags
                    document.getElementById('total-flags').textContent = data.total_flags;
                    
                    // Update phone status
                    const phoneStatus = document.getElementById('phone-status');
                    if (data.phone_detected) {
                        phoneStatus.textContent = 'üö® DETECTED!';
                        phoneStatus.classList.add('text-orange-400');
                        phoneStatus.classList.remove('text-green-400');
                    } else {
                        phoneStatus.textContent = '‚úÖ None';
                        phoneStatus.classList.add('text-green-400');
                        phoneStatus.classList.remove('text-orange-400');
                    }
                    
                    // Update phone flags
                    document.getElementById('phone-flags').textContent = data.phone_flags || 0;
                    
                    // Update attention monitoring
                    const attScore = data.attention_score || 100;
                    const attScoreEl = document.getElementById('attention-score');
                    attScoreEl.textContent = attScore.toFixed(0) + '%';
                    
                    // Color based on score
                    if (attScore >= 70) {
                        attScoreEl.classList.add('text-green-400');
                        attScoreEl.classList.remove('text-yellow-400', 'text-red-400');
                    } else if (attScore >= 40) {
                        attScoreEl.classList.add('text-yellow-400');
                        attScoreEl.classList.remove('text-green-400', 'text-red-400');
                    } else {
                        attScoreEl.classList.add('text-red-400');
                        attScoreEl.classList.remove('text-green-400', 'text-yellow-400');
                    }
                    
                    // Update attention status
                    const attStatus = data.attention_status || 'attentive';
                    const attStatusEl = document.getElementById('attention-status');
                    attStatusEl.textContent = attStatus.charAt(0).toUpperCase() + attStatus.slice(1);
                    
                    if (attStatus === 'attentive') {
                        attStatusEl.classList.add('text-green-400');
                        attStatusEl.classList.remove('text-yellow-400', 'text-red-400');
                    } else if (attStatus === 'distracted') {
                        attStatusEl.classList.add('text-yellow-400');
                        attStatusEl.classList.remove('text-green-400', 'text-red-400');
                    } else {
                        attStatusEl.classList.add('text-red-400');
                        attStatusEl.classList.remove('text-green-400', 'text-yellow-400');
                    }
                    
                    // Update facing score
                    const facingScore = data.facing_score || 100;
                    document.getElementById('facing-score').textContent = facingScore.toFixed(0) + '%';
                    
                    // Update occlusion status
                    const occlusionEl = document.getElementById('occlusion-status');
                    if (data.occlusion_detected) {
                        occlusionEl.textContent = '‚ö†Ô∏è Detected';
                        occlusionEl.classList.add('text-red-400');
                        occlusionEl.classList.remove('text-green-400');
                    } else {
                        occlusionEl.textContent = '‚úÖ None';
                        occlusionEl.classList.add('text-green-400');
                        occlusionEl.classList.remove('text-red-400');
                    }
                    
                    // Update mouth activity
                    const mouthActivity = data.mouth_activity || 0;
                    document.getElementById('mouth-activity').textContent = mouthActivity.toFixed(0) + '%';
                    
                    // Update tab switch stats
                    document.getElementById('tab-switches').textContent = data.tab_switches || 0;
                    document.getElementById('window-blurs').textContent = data.window_blurs || 0;
                    
                    // Update tab status
                    const tabStatus = document.getElementById('tab-status');
                    if (data.is_tab_visible) {
                        tabStatus.textContent = '‚úÖ Visible';
                        tabStatus.classList.add('text-green-400');
                        tabStatus.classList.remove('text-red-400');
                    } else {
                        tabStatus.textContent = '‚ö†Ô∏è Hidden';
                        tabStatus.classList.add('text-red-400');
                        tabStatus.classList.remove('text-green-400');
                    }
                    
                    // Update hand detection stats
                    document.getElementById('hands-detected').textContent = data.hands_detected || 0;
                    document.getElementById('hand-flags').textContent = data.hand_flags || 0;
                    
                    // Update left hand status
                    const leftHandStatus = document.getElementById('left-hand-status');
                    if (data.left_hand_visible) {
                        const leftFingers = data.fingers_extended?.left || [];
                        const fingerEmojis = ['üëç', '‚òùÔ∏è', 'üñï', 'üíç', 'ü§ô'];
                        const extended = leftFingers.map((ext, i) => ext ? fingerEmojis[i] : '').filter(e => e).join(' ');
                        leftHandStatus.textContent = `‚úÖ ${extended || '‚úä'}`;
                        leftHandStatus.classList.add('text-green-400');
                        leftHandStatus.classList.remove('text-gray-400');
                    } else {
                        leftHandStatus.textContent = '‚ùå';
                        leftHandStatus.classList.add('text-gray-400');
                        leftHandStatus.classList.remove('text-green-400');
                    }
                    
                    // Update right hand status
                    const rightHandStatus = document.getElementById('right-hand-status');
                    if (data.right_hand_visible) {
                        const rightFingers = data.fingers_extended?.right || [];
                        const fingerEmojis = ['üëç', '‚òùÔ∏è', 'üñï', 'üíç', 'ü§ô'];
                        const extended = rightFingers.map((ext, i) => ext ? fingerEmojis[i] : '').filter(e => e).join(' ');
                        rightHandStatus.textContent = `‚úÖ ${extended || '‚úä'}`;
                        rightHandStatus.classList.add('text-green-400');
                        rightHandStatus.classList.remove('text-gray-400');
                    } else {
                        rightHandStatus.textContent = '‚ùå';
                        rightHandStatus.classList.add('text-gray-400');
                        rightHandStatus.classList.remove('text-green-400');
                    }
                    
                    // Update gesture
                    document.getElementById('hand-gesture').textContent = data.hand_gesture || 'none';
                    
                    // Update eye tracking stats
                    const eyeOpenness = Math.round(data.eye_openness_avg || 100);
                    document.getElementById('eye-openness').textContent = `${eyeOpenness}%`;
                    if (data.is_blinking) {
                        document.getElementById('eye-openness').textContent = 'üëÅÔ∏è Blinking';
                    }
                    
                    document.getElementById('blink-count').textContent = data.blink_count || 0;
                    
                    // Update iris position display
                    const irisPos = data.iris_position || {left: {h: 0, v: 0}, right: {h: 0, v: 0}};
                    const avgH = ((irisPos.left?.h || 0) + (irisPos.right?.h || 0)) / 2;
                    const avgV = ((irisPos.left?.v || 0) + (irisPos.right?.v || 0)) / 2;
                    let irisText = 'Center';
                    if (Math.abs(avgH) > 0.3 || Math.abs(avgV) > 0.3) {
                        const hDir = avgH < -0.3 ? '‚Üê' : avgH > 0.3 ? '‚Üí' : '';
                        const vDir = avgV < -0.3 ? '‚Üë' : avgV > 0.3 ? '‚Üì' : '';
                        irisText = `${hDir}${vDir}` || 'Center';
                    }
                    document.getElementById('iris-position').textContent = irisText;
                    
                    // Update head roll
                    const headRoll = Math.round(data.head_roll || 0);
                    document.getElementById('head-roll').textContent = `${headRoll}¬∞`;
                    
                    // Update holding object status
                    const holdingObject = document.getElementById('holding-object');
                    if (data.hand_holding_object) {
                        holdingObject.textContent = 'üö® YES!';
                        holdingObject.classList.add('text-red-400');
                        holdingObject.classList.remove('text-green-400');
                    } else {
                        holdingObject.textContent = '‚ùå No';
                        holdingObject.classList.add('text-green-400');
                        holdingObject.classList.remove('text-red-400');
                    }
                    
                    // Update suspicious behaviors
                    const behaviorsElement = document.getElementById('suspicious-behaviors');
                    if (data.suspicious_behaviors && data.suspicious_behaviors.length > 0) {
                        const behaviorText = data.suspicious_behaviors
                            .map(b => b.replace(/_/g, ' '))
                            .map(b => b.charAt(0).toUpperCase() + b.slice(1))
                            .join(', ');
                        behaviorsElement.textContent = behaviorText;
                        behaviorsElement.classList.add('text-red-400');
                        behaviorsElement.classList.remove('text-orange-400');
                    } else {
                        behaviorsElement.textContent = 'None';
                        behaviorsElement.classList.add('text-orange-400');
                        behaviorsElement.classList.remove('text-red-400');
                    }
                    
                    // Update behavior flags
                    document.getElementById('behavior-flags').textContent = data.behavior_flags || 0;
                    
                    // Update overlay status
                    const overlay = document.getElementById('overlay-status');
                    const statusIcon = document.getElementById('status-icon');
                    const statusText = document.getElementById('status-text');
                    
                    overlay.classList.remove('looking-good', 'looking-away', 'no-face');
                    
                    if (data.status === 'no_face') {
                        overlay.classList.add('no-face');
                        statusIcon.textContent = '‚ö†Ô∏è';
                        statusText.textContent = 'No Face Detected';
                    } else if (data.is_looking_away) {
                        overlay.classList.add('looking-away');
                        statusIcon.textContent = '‚ùå';
                        statusText.textContent = 'Looking Away!';
                    } else {
                        overlay.classList.add('looking-good');
                        statusIcon.textContent = '‚úÖ';
                        statusText.textContent = 'Looking at Screen';
                    }
                    
                    // Update flag list if new flags
                    if (data.total_flags > lastFlagCount) {
                        updateFlagList(data.flags);
                        // Play alert sound
                        try {
                            document.getElementById('alert-sound').play();
                        } catch (e) {}
                        lastFlagCount = data.total_flags;
                    }
                    
                    // Update calibration info
                    const pitchOffset = data.pitch_offset || 0;
                    document.getElementById('pitch-offset').textContent = pitchOffset.toFixed(1) + '¬∞';
                    document.getElementById('calibration-status').textContent = 
                        data.calibrated ? '‚úÖ Calibr√©' : '‚è≥ En cours...';
                })
                .catch(err => console.error('Error fetching status:', err));
        }
        
        function updateFlagList(flags) {
            const flagList = document.getElementById('flag-list');
            
            if (flags.length === 0) {
                flagList.innerHTML = '<p class="text-gray-500 text-sm">No flags yet. Keep looking at the screen!</p>';
                return;
            }
            
            flagList.innerHTML = flags.slice().reverse().map((flag, index) => `
                <div class="flag-item flex items-center justify-between bg-red-500/20 rounded-lg p-3 border border-red-500/30">
                    <div>
                        <span class="text-red-400 font-medium">üö© Flag #${flags.length - index}</span>
                        <p class="text-sm text-gray-400">${flag.reason}</p>
                    </div>
                    <div class="text-right">
                        <span class="text-sm text-gray-300">${flag.time}</span>
                        <p class="text-xs text-gray-500">${flag.duration}</p>
                    </div>
                </div>
            `).join('');
        }
        
        function resetFlags() {
            fetch('/reset_flags')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        lastFlagCount = 0;
                        document.getElementById('total-flags').textContent = '0';
                        document.getElementById('flag-list').innerHTML = 
                            '<p class="text-gray-500 text-sm">No flags yet. Keep looking at the screen!</p>';
                    }
                });
        }
        
        function recalibrate() {
            fetch('/recalibrate')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('calibration-status').textContent = '‚è≥ En cours...';
                        document.getElementById('pitch-offset').textContent = '0.0¬∞';
                    }
                });
        }
        
        // Tab visibility detection
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // User switched tabs or minimized window
                isTabVisible = false;
                tabSwitchStartTime = Date.now();
                tabSwitchCount++;
                console.log('‚ö†Ô∏è Tab switched away or minimized');
                
                // Send flag to backend
                fetch('/tab_switch', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        action: 'hidden',
                        timestamp: new Date().toISOString()
                    })
                });
            } else {
                // User returned to tab
                isTabVisible = true;
                if (tabSwitchStartTime) {
                    const duration = ((Date.now() - tabSwitchStartTime) / 1000).toFixed(1);
                    console.log(`‚úÖ Tab returned after ${duration}s`);
                    
                    // Send return event to backend
                    fetch('/tab_switch', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            action: 'visible',
                            duration: duration,
                            timestamp: new Date().toISOString()
                        })
                    });
                    tabSwitchStartTime = null;
                }
            }
        });
        
        // Window focus/blur detection
        window.addEventListener('blur', function() {
            windowBlurCount++;
            console.log('‚ö†Ô∏è Window lost focus');
            
            fetch('/window_focus', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    action: 'blur',
                    timestamp: new Date().toISOString()
                })
            });
        });
        
        window.addEventListener('focus', function() {
            console.log('‚úÖ Window gained focus');
            
            fetch('/window_focus', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    action: 'focus',
                    timestamp: new Date().toISOString()
                })
            });
        });
        
        // Fullscreen exit detection
        document.addEventListener('fullscreenchange', function() {
            if (!document.fullscreenElement) {
                console.log('‚ö†Ô∏è Exited fullscreen');
                fetch('/fullscreen_exit', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        timestamp: new Date().toISOString()
                    })
                });
            }
        });
        
        // Window resize detection (catches minimize)
        let lastWindowState = {
            width: window.innerWidth,
            height: window.innerHeight,
            outerWidth: window.outerWidth,
            outerHeight: window.outerHeight
        };
        
        window.addEventListener('resize', function() {
            const currentState = {
                width: window.innerWidth,
                height: window.innerHeight,
                outerWidth: window.outerWidth,
                outerHeight: window.outerHeight
            };
            
            // Detect significant resize (possible minimize or window manipulation)
            const widthChange = Math.abs(currentState.width - lastWindowState.width);
            const heightChange = Math.abs(currentState.height - lastWindowState.height);
            
            if (widthChange > 100 || heightChange > 100) {
                console.log('‚ö†Ô∏è Window resized significantly');
                fetch('/window_resize', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        timestamp: new Date().toISOString(),
                        oldSize: lastWindowState,
                        newSize: currentState
                    })
                });
            }
            
            lastWindowState = currentState;
        });
        
        // Update every 500ms
        setInterval(updateStatus, 500);
        
        // Initial update
        updateStatus();
    </script>
</body>
</html>
