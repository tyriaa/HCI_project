<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus Monitor Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: { 900: '#0a0a0f', 800: '#12121a', 700: '#1a1a24', 600: '#22222e' },
                        accent: { primary: '#6366f1', secondary: '#8b5cf6', success: '#10b981', warning: '#f59e0b', danger: '#ef4444' }
                    }
                }
            }
        }
    </script>
    <style>
        * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; box-sizing: border-box; }
        html, body { height: 100%; margin: 0; padding: 0; }
        body { background: #0a0a0f; overflow: hidden; }
        
        /* Glassmorphism */
        .glass { background: rgba(255,255,255,0.03); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.08); }
        
        /* Video container */
        .video-wrapper { position: relative; border-radius: 16px; overflow: hidden; box-shadow: 0 0 40px rgba(99,102,241,0.15); }
        .video-wrapper::before { content: ''; position: absolute; inset: 0; border-radius: 16px; padding: 1px; background: linear-gradient(135deg, rgba(99,102,241,0.4), transparent, rgba(139,92,246,0.4)); -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); mask-composite: exclude; pointer-events: none; z-index: 10; }
        
        /* Status dot */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; animation: pulse-dot 2s infinite; }
        .status-dot.active { background: #10b981; box-shadow: 0 0 12px rgba(16,185,129,0.6); }
        .status-dot.warning { background: #f59e0b; box-shadow: 0 0 12px rgba(245,158,11,0.6); }
        .status-dot.danger { background: #ef4444; box-shadow: 0 0 12px rgba(239,68,68,0.6); }
        @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        
        /* Progress ring */
        .progress-ring { transform: rotate(-90deg); }
        .progress-ring-circle { transition: stroke-dashoffset 0.4s ease; }
        
        /* Animations */
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        .animate-slideIn { animation: slideIn 0.3s ease-out; }
        
        /* Gradient text */
        .gradient-text { background: linear-gradient(135deg, #6366f1, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        
        /* Glow effects */
        .glow-success { box-shadow: 0 0 20px rgba(16,185,129,0.25); }
        .glow-danger { box-shadow: 0 0 20px rgba(239,68,68,0.25); }
        .glow-warning { box-shadow: 0 0 20px rgba(245,158,11,0.25); }
        
        /* Compact scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }
    </style>
</head>
<body class="text-white h-full">
    <!-- Background -->
    <div class="fixed inset-0 bg-gradient-to-br from-indigo-900/10 via-transparent to-purple-900/10 pointer-events-none"></div>
    
    <div class="relative h-full flex flex-col p-3">
        <!-- Compact Header -->
        <header class="flex items-center justify-between mb-3 flex-shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-lg font-bold gradient-text">Focus Monitor Pro</h1>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <div class="flex items-center gap-1.5 px-2 py-1 rounded-full glass text-xs">
                    <div class="status-dot active"></div>
                    <span class="text-gray-400">Live</span>
                </div>
                <button onclick="resetFlags()" class="px-2 py-1 text-xs rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30">Reset</button>
                <button onclick="recalibrate()" class="px-2 py-1 text-xs rounded-lg bg-indigo-500/20 text-indigo-400 hover:bg-indigo-500/30">Calibrate</button>
                <button onclick="confirmQuit()" class="px-2 py-1 text-xs rounded-lg bg-red-600/30 text-red-400 hover:bg-red-600/50 border border-red-500/40 flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                    Close
                </button>
            </div>
        </header>
        
        <!-- Quit Confirmation Modal -->
        <div id="quit-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden flex items-center justify-center">
            <div class="glass rounded-2xl p-6 max-w-sm mx-4 border border-red-500/30 shadow-2xl">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center">
                        <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-white">Quit Application?</h3>
                </div>
                <p class="text-gray-400 text-sm mb-6">Are you sure you want to quit? This will close the monitoring session and stop the server.</p>
                <div class="flex gap-3">
                    <button onclick="cancelQuit()" class="flex-1 px-4 py-2 rounded-lg bg-gray-700/50 text-gray-300 hover:bg-gray-700 transition-colors text-sm font-medium">Cancel</button>
                    <button onclick="executeQuit()" class="flex-1 px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition-colors text-sm font-medium">Yes, Quit</button>
                </div>
            </div>
        </div>
        
        <!-- Main Content - Fills remaining space -->
        <div class="flex-1 grid grid-cols-12 gap-3 min-h-0">
            <!-- Left: Video + Stats below -->
            <div class="col-span-8 flex flex-col gap-3 min-h-0">
                <!-- Video Feed -->
                <div class="video-wrapper flex-1 min-h-0">
                    <img id="video-feed" src="/video_feed" alt="Video Feed" class="w-full h-full object-contain bg-black">
                    
                    <!-- Status Badge -->
                    <div id="overlay-status" class="absolute top-3 left-3 flex items-center gap-2 px-3 py-1.5 rounded-lg glass glow-success">
                        <div id="status-dot" class="status-dot active"></div>
                        <span id="status-text" class="text-xs font-medium">Initializing...</span>
                    </div>
                    
                    <!-- Attention Ring -->
                    <div class="absolute top-3 right-3 glass rounded-lg p-2">
                        <div class="relative w-12 h-12">
                            <svg class="progress-ring w-12 h-12" viewBox="0 0 44 44">
                                <circle cx="22" cy="22" r="18" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="3"/>
                                <circle id="attention-ring" class="progress-ring-circle" cx="22" cy="22" r="18" fill="none" stroke="#10b981" stroke-width="3" stroke-linecap="round" stroke-dasharray="113.1" stroke-dashoffset="0"/>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span id="attention-score-overlay" class="text-sm font-bold">100</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bottom Bar -->
                    <div class="absolute bottom-0 left-0 right-0 px-3 py-2 bg-gradient-to-t from-black/80 to-transparent">
                        <div class="flex items-center justify-between text-xs">
                            <div class="flex items-center gap-3">
                                <span><span class="text-gray-500">Face:</span> <span id="face-direction" class="text-green-400 font-medium">Center</span></span>
                                <span><span class="text-gray-500">Iris:</span> <span id="iris-direction" class="text-cyan-400 font-medium">Center</span></span>
                                <span id="signal-agree" class="text-green-400">‚úì</span>
                                <span><span class="text-gray-500">Conf:</span> <span id="attention-conf" class="text-green-400 font-medium">high</span></span>
                            </div>
                            <div id="flags-badge" class="flex items-center gap-1 px-2 py-0.5 rounded bg-red-500/20 border border-red-500/30 hidden">
                                <span class="text-red-400 font-medium" id="flags-count-overlay">0</span>
                                <span class="text-gray-500">flags</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Bottom Stats Row -->
                <div class="grid grid-cols-8 gap-2 flex-shrink-0">
                    <div class="glass rounded-lg p-2 text-center">
                        <p class="text-xs text-gray-500">Eyes</p>
                        <p id="eye-openness" class="text-sm font-semibold text-green-400">100%</p>
                    </div>
                    <div class="glass rounded-lg p-2 text-center">
                        <p class="text-xs text-gray-500">Blinks</p>
                        <p id="blink-count" class="text-sm font-semibold text-blue-400">0</p>
                    </div>
                    <div class="glass rounded-lg p-2 text-center">
                        <p class="text-xs text-gray-500">Away</p>
                        <p id="looking-away-duration" class="text-sm font-semibold text-purple-400">0.0s</p>
                    </div>
                    <div class="glass rounded-lg p-2 text-center">
                        <p class="text-xs text-gray-500">Roll</p>
                        <p id="head-roll" class="text-sm font-semibold text-purple-400">0¬∞</p>
                    </div>
                    <div class="glass rounded-lg p-2 text-center">
                        <p class="text-xs text-gray-500">Tabs</p>
                        <p id="tab-switches" class="text-sm font-semibold text-yellow-400">0</p>
                    </div>
                    <div class="glass rounded-lg p-2 text-center">
                        <p class="text-xs text-gray-500">Blurs</p>
                        <p id="window-blurs" class="text-sm font-semibold text-yellow-400">0</p>
                    </div>
                    <div class="glass rounded-lg p-2 text-center">
                        <p class="text-xs text-gray-500">Mouth</p>
                        <p id="mouth-activity" class="text-sm font-semibold text-pink-400">0%</p>
                    </div>
                    <div class="glass rounded-lg p-2 text-center">
                        <p class="text-xs text-gray-500">Tab</p>
                        <p id="tab-status" class="text-sm font-semibold text-green-400">OK</p>
                    </div>
                </div>
            </div>
            
            <!-- Right Sidebar -->
            <div class="col-span-4 flex flex-col gap-2 min-h-0 overflow-y-auto pr-1">
                <!-- Attention Score -->
                <div class="glass rounded-lg p-2 flex-shrink-0">
                    <div class="flex items-center gap-2">
                        <div class="relative flex-shrink-0">
                            <svg class="progress-ring w-12 h-12" viewBox="0 0 60 60">
                                <circle cx="30" cy="30" r="26" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="4"/>
                                <circle id="attention-ring-main" class="progress-ring-circle" cx="30" cy="30" r="26" fill="none" stroke="url(#gradient)" stroke-width="4" stroke-linecap="round" stroke-dasharray="163.4" stroke-dashoffset="0"/>
                                <defs>
                                    <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" stop-color="#10b981"/>
                                        <stop offset="100%" stop-color="#6366f1"/>
                                    </linearGradient>
                                </defs>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span id="attention-score" class="text-lg font-bold">100</span>
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between">
                                <span class="text-xs text-gray-500 uppercase">Attention</span>
                                <span id="attention-status" class="px-1.5 py-0.5 text-xs rounded bg-green-500/20 text-green-400">Attentive</span>
                            </div>
                            <div class="grid grid-cols-3 gap-1 mt-1">
                                <div class="text-center py-0.5 rounded bg-white/5">
                                    <p class="text-[10px] text-gray-500">Face</p>
                                    <p id="sidebar-face-dir" class="text-xs font-semibold text-green-400">Center</p>
                                </div>
                                <div class="text-center py-0.5 rounded bg-white/5">
                                    <p class="text-[10px] text-gray-500">Iris</p>
                                    <p id="sidebar-iris-dir" class="text-xs font-semibold text-cyan-400">Center</p>
                                </div>
                                <div class="text-center py-0.5 rounded bg-white/5">
                                    <p class="text-[10px] text-gray-500">Facing</p>
                                    <p id="facing-score" class="text-xs font-semibold text-indigo-400">100%</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Emotion Detection -->
                <div class="glass rounded-lg p-2 flex-shrink-0">
                    <div class="flex items-center gap-2">
                        <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-pink-500/20 to-purple-500/20 flex items-center justify-center text-xl" id="emotion-emoji">üòê</div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between">
                                <p id="emotion-name" class="text-sm font-semibold text-pink-400">Neutral</p>
                                <span id="emotion-confidence" class="text-xs text-gray-500">0%</span>
                            </div>
                            <div class="h-1 bg-white/10 rounded-full overflow-hidden mt-1">
                                <div id="emotion-bar" class="h-full bg-gradient-to-r from-pink-500 to-purple-500 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Detection + Hands Combined -->
                <div class="glass rounded-lg p-2 flex-shrink-0">
                    <div class="grid grid-cols-4 gap-1">
                        <div class="flex flex-col items-center p-1 rounded bg-white/5">
                            <span class="text-[10px] text-gray-500">Phone</span>
                            <span id="phone-status" class="text-xs font-medium text-green-400">None</span>
                        </div>
                        <div class="flex flex-col items-center p-1 rounded bg-white/5">
                            <span class="text-[10px] text-gray-500">Occl</span>
                            <span id="occlusion-status" class="text-xs font-medium text-green-400">None</span>
                        </div>
                        <div class="flex flex-col items-center p-1 rounded bg-white/5">
                            <span class="text-[10px] text-gray-500">Hold</span>
                            <span id="holding-object" class="text-xs font-medium text-green-400">No</span>
                        </div>
                        <div class="flex flex-col items-center p-1 rounded bg-white/5">
                            <span class="text-[10px] text-gray-500">Gesture</span>
                            <span id="hand-gesture" class="text-xs font-medium text-cyan-400">none</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-1 mt-1">
                        <div class="text-center p-1 rounded bg-white/5">
                            <span class="text-sm">ü§ö</span>
                            <p id="left-hand-status" class="text-[10px] text-gray-400">Hidden</p>
                        </div>
                        <div class="text-center p-1 rounded bg-white/5">
                            <span class="text-sm">‚úã</span>
                            <p id="right-hand-status" class="text-[10px] text-gray-400">Hidden</p>
                        </div>
                        <div class="text-center p-1 rounded bg-white/5">
                            <p class="text-[10px] text-gray-500">Hands</p>
                            <p id="hands-detected" class="text-sm font-bold text-blue-400">0</p>
                        </div>
                    </div>
                </div>
                
                <!-- Flags Grid -->
                <div class="glass rounded-lg p-2 flex-shrink-0">
                    <div class="grid grid-cols-5 gap-1">
                        <div class="text-center p-1 rounded bg-red-500/10 border border-red-500/20">
                            <p id="total-flags" class="text-sm font-bold text-red-400">0</p>
                            <p class="text-[10px] text-gray-500">Total</p>
                        </div>
                        <div class="text-center p-1 rounded bg-orange-500/10 border border-orange-500/20">
                            <p id="phone-flags" class="text-sm font-bold text-orange-400">0</p>
                            <p class="text-[10px] text-gray-500">Phone</p>
                        </div>
                        <div class="text-center p-1 rounded bg-purple-500/10 border border-purple-500/20">
                            <p id="hand-flags" class="text-sm font-bold text-purple-400">0</p>
                            <p class="text-[10px] text-gray-500">Hand</p>
                        </div>
                        <div class="text-center p-1 rounded bg-yellow-500/10 border border-yellow-500/20">
                            <p id="behavior-flags" class="text-sm font-bold text-yellow-400">0</p>
                            <p class="text-[10px] text-gray-500">Behav</p>
                        </div>
                        <div class="text-center p-1 rounded bg-blue-500/10 border border-blue-500/20">
                            <p id="window-flags" class="text-sm font-bold text-blue-400">0</p>
                            <p class="text-[10px] text-gray-500">Window</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-1 mt-1 p-1 rounded bg-white/5 text-[10px]">
                        <span class="text-gray-500">Suspicious:</span>
                        <span id="suspicious-behaviors" class="text-yellow-400 truncate">None</span>
                    </div>
                </div>
                
                <!-- Calibration -->
                <div class="glass rounded-lg p-2 flex-shrink-0">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] text-gray-500">Pitch:</span>
                            <span id="pitch-offset" class="text-xs font-mono text-indigo-400">0.0¬∞</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] text-gray-500">Cal:</span>
                            <span id="calibration-status" class="text-xs text-yellow-400">Pending</span>
                        </div>
                    </div>
                </div>
                
                <!-- Flag History -->
                <div class="glass rounded-lg p-2 flex-1 min-h-[80px] flex flex-col">
                    <h3 class="text-[10px] text-gray-500 uppercase mb-1 flex-shrink-0">Flag History</h3>
                    <div id="flag-list" class="flex-1 overflow-y-auto space-y-0.5 text-[10px]">
                        <p class="text-gray-600 text-center py-1">No flags</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Alert Sound (optional) -->
    <audio id="alert-sound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleQAA" type="audio/wav">
    </audio>
    
    <script>
        let lastFlagCount = 0;
        let previousFlags = [];
        let tabSwitchCount = 0;
        let windowBlurCount = 0;
        let isTabVisible = true;
        let tabSwitchStartTime = null;
        
        // Update status periodically
        function updateStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    try {
                    // Debug log
                    console.log('Status update:', data.face_direction, data.iris_direction, data.attention_confidence);
                    
                    // Update looking away duration
                    const duration = data.looking_away_duration || 0;
                    document.getElementById('looking-away-duration').textContent = duration.toFixed(1) + 's';
                    
                    // Update total flags
                    document.getElementById('total-flags').textContent = data.total_flags;
                    
                    // Update phone status
                    const phoneStatus = document.getElementById('phone-status');
                    if (data.phone_detected) {
                        phoneStatus.textContent = 'Yes!';
                        phoneStatus.classList.add('text-red-400');
                        phoneStatus.classList.remove('text-green-400');
                    } else {
                        phoneStatus.textContent = 'None';
                        phoneStatus.classList.add('text-green-400');
                        phoneStatus.classList.remove('text-red-400');
                    }
                    
                    // Update phone flags
                    document.getElementById('phone-flags').textContent = data.phone_flags || 0;
                    
                    // Update attention monitoring
                    const attScore = data.attention_score || 100;
                    const attScoreEl = document.getElementById('attention-score');
                    attScoreEl.textContent = Math.round(attScore);
                    
                    // Update circular progress ring (r=26, circumference = 2*PI*26 = 163.4)
                    const circumference = 163.4;
                    const offset = circumference - (attScore / 100) * circumference;
                    const ringEl = document.getElementById('attention-ring-main');
                    if (ringEl) ringEl.style.strokeDashoffset = offset;
                    
                    // Update overlay attention ring too (r=18, circumference = 113.1)
                    const overlayRing = document.getElementById('attention-ring');
                    if (overlayRing) {
                        const overlayCircum = 113.1;
                        overlayRing.style.strokeDashoffset = overlayCircum - (attScore / 100) * overlayCircum;
                    }
                    
                    // Update overlay score
                    const overlayScore = document.getElementById('attention-score-overlay');
                    if (overlayScore) overlayScore.textContent = Math.round(attScore);
                    
                    // Update attention status badge
                    const attStatus = data.attention_status || 'attentive';
                    const attStatusEl = document.getElementById('attention-status');
                    attStatusEl.textContent = attStatus.charAt(0).toUpperCase() + attStatus.slice(1);
                    
                    // Update status badge styling
                    attStatusEl.classList.remove('bg-green-500/20', 'text-green-400', 'bg-yellow-500/20', 'text-yellow-400', 'bg-red-500/20', 'text-red-400');
                    if (attStatus === 'attentive') {
                        attStatusEl.classList.add('bg-green-500/20', 'text-green-400');
                    } else if (attStatus === 'distracted') {
                        attStatusEl.classList.add('bg-yellow-500/20', 'text-yellow-400');
                    } else {
                        attStatusEl.classList.add('bg-red-500/20', 'text-red-400');
                    }
                    
                    // Update facing score
                    const facingScore = data.facing_score || 100;
                    document.getElementById('facing-score').textContent = facingScore.toFixed(0) + '%';
                    
                    // Update occlusion status
                    const occlusionEl = document.getElementById('occlusion-status');
                    if (data.occlusion_detected) {
                        occlusionEl.textContent = 'Yes';
                        occlusionEl.classList.add('text-red-400');
                        occlusionEl.classList.remove('text-green-400');
                    } else {
                        occlusionEl.textContent = 'None';
                        occlusionEl.classList.add('text-green-400');
                        occlusionEl.classList.remove('text-red-400');
                    }
                    
                    // Update emotion detection
                    const emotionEmojis = {
                        'happy': 'üòä', 'sad': 'üò¢', 'angry': 'üò†', 'surprise': 'üò≤',
                        'fear': 'üò®', 'disgust': 'ü§¢', 'neutral': 'üòê', 'unknown': '‚ùì'
                    };
                    const emotion = data.emotion || 'unknown';
                    const emotionConf = data.emotion_confidence || 0;
                    document.getElementById('emotion-emoji').textContent = emotionEmojis[emotion] || 'üòê';
                    document.getElementById('emotion-name').textContent = emotion.charAt(0).toUpperCase() + emotion.slice(1);
                    document.getElementById('emotion-confidence').textContent = Math.round(emotionConf) + '%';
                    document.getElementById('emotion-bar').style.width = emotionConf + '%';
                    
                    // Update mouth activity
                    const mouthActivity = data.mouth_activity || 0;
                    document.getElementById('mouth-activity').textContent = mouthActivity.toFixed(0) + '%';
                    
                    // Update tab switch stats
                    document.getElementById('tab-switches').textContent = data.tab_switches || 0;
                    document.getElementById('window-blurs').textContent = data.window_blurs || 0;
                    
                    // Update tab status
                    const tabStatus = document.getElementById('tab-status');
                    if (data.is_tab_visible) {
                        tabStatus.textContent = 'OK';
                        tabStatus.classList.add('text-green-400');
                        tabStatus.classList.remove('text-red-400');
                    } else {
                        tabStatus.textContent = 'Away';
                        tabStatus.classList.add('text-red-400');
                        tabStatus.classList.remove('text-green-400');
                    }
                    
                    // Update hand detection stats
                    document.getElementById('hands-detected').textContent = data.hands_detected || 0;
                    document.getElementById('hand-flags').textContent = data.hand_flags || 0;
                    
                    // Update left hand status
                    const leftHandStatus = document.getElementById('left-hand-status');
                    if (data.left_hand_visible) {
                        leftHandStatus.textContent = 'Visible';
                        leftHandStatus.classList.add('text-green-400');
                        leftHandStatus.classList.remove('text-gray-400');
                    } else {
                        leftHandStatus.textContent = 'Hidden';
                        leftHandStatus.classList.add('text-gray-400');
                        leftHandStatus.classList.remove('text-green-400');
                    }
                    
                    // Update right hand status
                    const rightHandStatus = document.getElementById('right-hand-status');
                    if (data.right_hand_visible) {
                        rightHandStatus.textContent = 'Visible';
                        rightHandStatus.classList.add('text-green-400');
                        rightHandStatus.classList.remove('text-gray-400');
                    } else {
                        rightHandStatus.textContent = 'Hidden';
                        rightHandStatus.classList.add('text-gray-400');
                        rightHandStatus.classList.remove('text-green-400');
                    }
                    
                    // Update gesture
                    document.getElementById('hand-gesture').textContent = data.hand_gesture || 'none';
                    
                    // Update eye tracking stats
                    const eyeOpenness = Math.round(data.eye_openness_avg || 100);
                    document.getElementById('eye-openness').textContent = `${eyeOpenness}%`;
                    if (data.is_blinking) {
                        document.getElementById('eye-openness').textContent = 'üëÅÔ∏è Blinking';
                    }
                    
                    document.getElementById('blink-count').textContent = data.blink_count || 0;
                    
                    // Update hierarchical face/iris direction display
                    const faceDir = data.face_direction || 'center';
                    const irisDir = data.iris_direction || 'center';
                    const signalAgree = data.signal_agreement !== false;
                    const attConf = data.attention_confidence || 'high';
                    
                    // Update face direction
                    const faceDirEl = document.getElementById('face-direction');
                    faceDirEl.textContent = faceDir.charAt(0).toUpperCase() + faceDir.slice(1);
                    if (faceDir === 'center') {
                        faceDirEl.classList.add('text-green-400');
                        faceDirEl.classList.remove('text-red-400', 'text-yellow-400');
                    } else {
                        faceDirEl.classList.add('text-red-400');
                        faceDirEl.classList.remove('text-green-400', 'text-yellow-400');
                    }
                    
                    // Update iris direction
                    const irisDirEl = document.getElementById('iris-direction');
                    irisDirEl.textContent = irisDir.charAt(0).toUpperCase() + irisDir.slice(1);
                    if (irisDir === 'center') {
                        irisDirEl.classList.add('text-cyan-400');
                        irisDirEl.classList.remove('text-red-400', 'text-yellow-400');
                    } else {
                        irisDirEl.classList.add('text-yellow-400');
                        irisDirEl.classList.remove('text-cyan-400', 'text-red-400');
                    }
                    
                    // Update signal agreement indicator
                    const agreeEl = document.getElementById('signal-agree');
                    if (signalAgree) {
                        agreeEl.textContent = '‚úì';
                        agreeEl.classList.add('text-green-400');
                        agreeEl.classList.remove('text-red-400');
                    } else {
                        agreeEl.textContent = '‚úó';
                        agreeEl.classList.add('text-yellow-400');
                        agreeEl.classList.remove('text-green-400');
                    }
                    
                    // Update attention confidence
                    const confEl = document.getElementById('attention-conf');
                    confEl.textContent = attConf;
                    confEl.classList.remove('text-green-400', 'text-yellow-400', 'text-red-400', 'text-gray-400');
                    if (attConf === 'high') confEl.classList.add('text-green-400');
                    else if (attConf === 'low' || attConf === 'uncertain') confEl.classList.add('text-yellow-400');
                    else if (attConf === 'very_low') confEl.classList.add('text-red-400');
                    else confEl.classList.add('text-gray-400');
                    
                    // Update sidebar face/iris directions
                    const sidebarFace = document.getElementById('sidebar-face-dir');
                    const sidebarIris = document.getElementById('sidebar-iris-dir');
                    if (sidebarFace) {
                        sidebarFace.textContent = faceDir.charAt(0).toUpperCase() + faceDir.slice(1);
                        sidebarFace.classList.remove('text-green-400', 'text-red-400');
                        sidebarFace.classList.add(faceDir === 'center' ? 'text-green-400' : 'text-red-400');
                    }
                    if (sidebarIris) {
                        sidebarIris.textContent = irisDir.charAt(0).toUpperCase() + irisDir.slice(1);
                        sidebarIris.classList.remove('text-cyan-400', 'text-yellow-400');
                        sidebarIris.classList.add(irisDir === 'center' ? 'text-cyan-400' : 'text-yellow-400');
                    }
                    
                    // Update head roll
                    const headRoll = Math.round(data.head_roll || 0);
                    document.getElementById('head-roll').textContent = `${headRoll}¬∞`;
                    
                    // Update holding object status
                    const holdingObject = document.getElementById('holding-object');
                    if (data.hand_holding_object) {
                        holdingObject.textContent = 'Yes';
                        holdingObject.classList.add('text-red-400');
                        holdingObject.classList.remove('text-green-400');
                    } else {
                        holdingObject.textContent = 'No';
                        holdingObject.classList.add('text-green-400');
                        holdingObject.classList.remove('text-red-400');
                    }
                    
                    // Update suspicious behaviors
                    const behaviorsElement = document.getElementById('suspicious-behaviors');
                    if (data.suspicious_behaviors && data.suspicious_behaviors.length > 0) {
                        const behaviorText = data.suspicious_behaviors
                            .map(b => b.replace(/_/g, ' '))
                            .map(b => b.charAt(0).toUpperCase() + b.slice(1))
                            .join(', ');
                        behaviorsElement.textContent = behaviorText;
                        behaviorsElement.classList.add('text-red-400');
                        behaviorsElement.classList.remove('text-orange-400');
                    } else {
                        behaviorsElement.textContent = 'None';
                        behaviorsElement.classList.add('text-orange-400');
                        behaviorsElement.classList.remove('text-red-400');
                    }
                    
                    // Update behavior flags
                    document.getElementById('behavior-flags').textContent = data.behavior_flags || 0;
                    
                    // Update window flags (tab switches + window blurs)
                    const windowFlagsEl = document.getElementById('window-flags');
                    if (windowFlagsEl) {
                        windowFlagsEl.textContent = (data.tab_switches || 0) + (data.window_blurs || 0);
                    }
                    
                    // Update overlay status
                    const overlay = document.getElementById('overlay-status');
                    const statusDot = document.getElementById('status-dot');
                    const statusText = document.getElementById('status-text');
                    
                    overlay.classList.remove('glow-success', 'glow-danger', 'glow-warning');
                    statusDot.classList.remove('active', 'warning', 'danger');
                    
                    if (data.status === 'no_face') {
                        overlay.classList.add('glow-warning');
                        statusDot.classList.add('warning');
                        statusText.textContent = 'No Face Detected';
                    } else if (data.is_looking_away) {
                        overlay.classList.add('glow-danger');
                        statusDot.classList.add('danger');
                        // Show confidence level in status
                        const conf = data.attention_confidence || 'high';
                        if (conf === 'high') {
                            statusText.textContent = 'Looking Away';
                        } else if (conf === 'low') {
                            statusText.textContent = 'Head Turned';
                        } else {
                            statusText.textContent = 'Eyes Away';
                        }
                    } else {
                        overlay.classList.add('glow-success');
                        statusDot.classList.add('active');
                        // Show if peripheral attention
                        if (data.attention_confidence === 'uncertain') {
                            statusText.textContent = 'Peripheral';
                        } else {
                            statusText.textContent = 'Focused';
                        }
                    }
                    
                    // Update flags badge visibility
                    const flagsBadge = document.getElementById('flags-badge');
                    const flagsCountOverlay = document.getElementById('flags-count-overlay');
                    if (flagsBadge && data.total_flags > 0) {
                        flagsBadge.classList.remove('hidden');
                        if (flagsCountOverlay) flagsCountOverlay.textContent = data.total_flags;
                    }
                    
                    // Update flag list if new flags
                    if (data.total_flags > lastFlagCount) {
                        updateFlagList(data.flags);
                        // Play alert sound
                        try {
                            document.getElementById('alert-sound').play();
                        } catch (e) {}
                        lastFlagCount = data.total_flags;
                    }
                    
                    // Update calibration info
                    const pitchOffset = data.pitch_offset || 0;
                    document.getElementById('pitch-offset').textContent = pitchOffset.toFixed(1) + '¬∞';
                    const calStatus = document.getElementById('calibration-status');
                    if (data.calibrated) {
                        calStatus.textContent = 'Calibrated';
                        calStatus.classList.remove('text-yellow-400');
                        calStatus.classList.add('text-green-400');
                    } else {
                        calStatus.textContent = 'Calibrating...';
                        calStatus.classList.remove('text-green-400');
                        calStatus.classList.add('text-yellow-400');
                    }
                    } catch (e) {
                        console.error('Error updating UI:', e);
                    }
                })
                .catch(err => console.error('Error fetching status:', err));
        }
        
        function updateFlagList(flags) {
            const flagList = document.getElementById('flag-list');
            
            if (flags.length === 0) {
                flagList.innerHTML = '<p class="text-gray-600 text-center py-1">No flags</p>';
                return;
            }
            
            flagList.innerHTML = flags.slice().reverse().slice(0, 10).map((flag, index) => `
                <div class="animate-slideIn flex items-center gap-1 px-1 py-0.5 rounded bg-red-500/10 border border-red-500/20">
                    <span class="text-red-400 font-medium">#${flags.length - index}</span>
                    <span class="text-gray-400 truncate flex-1">${flag.reason}</span>
                </div>
            `).join('');
        }
        
        function resetFlags() {
            fetch('/reset_flags')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        lastFlagCount = 0;
                        document.getElementById('total-flags').textContent = '0';
                        document.getElementById('phone-flags').textContent = '0';
                        document.getElementById('hand-flags').textContent = '0';
                        document.getElementById('behavior-flags').textContent = '0';
                        document.getElementById('window-flags').textContent = '0';
                        document.getElementById('tab-switches').textContent = '0';
                        document.getElementById('window-blurs').textContent = '0';
                        document.getElementById('flag-list').innerHTML = '<p class="text-gray-600 text-center py-1">No flags</p>';
                        const flagsBadge = document.getElementById('flags-badge');
                        if (flagsBadge) flagsBadge.classList.add('hidden');
                    }
                });
        }
        
        function recalibrate() {
            fetch('/recalibrate')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('calibration-status').textContent = 'Calibrating';
                        document.getElementById('calibration-status').classList.remove('text-green-400');
                        document.getElementById('calibration-status').classList.add('text-yellow-400');
                        document.getElementById('pitch-offset').textContent = '0.0¬∞';
                    }
                });
        }
        
        // Tab visibility detection
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // User switched tabs or minimized window
                isTabVisible = false;
                tabSwitchStartTime = Date.now();
                tabSwitchCount++;
                console.log('‚ö†Ô∏è Tab switched away or minimized');
                
                // Send flag to backend
                fetch('/tab_switch', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        action: 'hidden',
                        timestamp: new Date().toISOString()
                    })
                });
            } else {
                // User returned to tab
                isTabVisible = true;
                if (tabSwitchStartTime) {
                    const duration = ((Date.now() - tabSwitchStartTime) / 1000).toFixed(1);
                    console.log(`‚úÖ Tab returned after ${duration}s`);
                    
                    // Send return event to backend
                    fetch('/tab_switch', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            action: 'visible',
                            duration: duration,
                            timestamp: new Date().toISOString()
                        })
                    });
                    tabSwitchStartTime = null;
                }
            }
        });
        
        // Window focus/blur detection
        window.addEventListener('blur', function() {
            windowBlurCount++;
            console.log('‚ö†Ô∏è Window lost focus');
            
            fetch('/window_focus', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    action: 'blur',
                    timestamp: new Date().toISOString()
                })
            });
        });
        
        window.addEventListener('focus', function() {
            console.log('‚úÖ Window gained focus');
            
            fetch('/window_focus', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    action: 'focus',
                    timestamp: new Date().toISOString()
                })
            });
        });
        
        // Fullscreen exit detection
        document.addEventListener('fullscreenchange', function() {
            if (!document.fullscreenElement) {
                console.log('‚ö†Ô∏è Exited fullscreen');
                fetch('/fullscreen_exit', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        timestamp: new Date().toISOString()
                    })
                });
            }
        });
        
        // Window resize detection (catches minimize)
        let lastWindowState = {
            width: window.innerWidth,
            height: window.innerHeight,
            outerWidth: window.outerWidth,
            outerHeight: window.outerHeight
        };
        
        window.addEventListener('resize', function() {
            const currentState = {
                width: window.innerWidth,
                height: window.innerHeight,
                outerWidth: window.outerWidth,
                outerHeight: window.outerHeight
            };
            
            // Detect significant resize (possible minimize or window manipulation)
            const widthChange = Math.abs(currentState.width - lastWindowState.width);
            const heightChange = Math.abs(currentState.height - lastWindowState.height);
            
            if (widthChange > 100 || heightChange > 100) {
                console.log('‚ö†Ô∏è Window resized significantly');
                fetch('/window_resize', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        timestamp: new Date().toISOString(),
                        oldSize: lastWindowState,
                        newSize: currentState
                    })
                });
            }
            
            lastWindowState = currentState;
        });
        
        // Update every 500ms
        setInterval(updateStatus, 500);
        
        // Initial update
        updateStatus();
        
        // Quit confirmation functions
        function confirmQuit() {
            document.getElementById('quit-modal').classList.remove('hidden');
        }
        
        function cancelQuit() {
            document.getElementById('quit-modal').classList.add('hidden');
        }
        
        function executeQuit() {
            // Show closing message
            document.getElementById('quit-modal').innerHTML = `
                <div class="glass rounded-2xl p-6 max-w-sm mx-4 border border-red-500/30 shadow-2xl text-center">
                    <div class="w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center mx-auto mb-4">
                        <svg class="w-5 h-5 text-red-400 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                    <p class="text-gray-300">Shutting down...</p>
                </div>
            `;
            
            // Send shutdown request to backend
            fetch('/shutdown', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            }).then(() => {
                // Close the tab after a short delay
                setTimeout(() => {
                    window.close();
                    // If window.close() doesn't work (browser restriction), show message
                    document.getElementById('quit-modal').innerHTML = `
                        <div class="glass rounded-2xl p-6 max-w-sm mx-4 border border-green-500/30 shadow-2xl text-center">
                            <div class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center mx-auto mb-4">
                                <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                            </div>
                            <p class="text-gray-300 mb-2">Server stopped successfully!</p>
                            <p class="text-gray-500 text-sm">You can now close this tab.</p>
                        </div>
                    `;
                }, 500);
            }).catch(() => {
                // Server already stopped
                setTimeout(() => window.close(), 100);
            });
        }
    </script>
</body>
</html>
