<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eye Gaze Detection - Screen Focus Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
        }
        
        .video-container {
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        
        .status-badge {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .flag-alert {
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .looking-good {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .looking-away {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .no-face {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .flag-item {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
</head>
<body class="text-white">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-2">
                <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">
                    üëÅÔ∏è Eye Gaze Detection
                </span>
            </h1>
            <p class="text-gray-400">Real-time screen focus monitoring</p>
        </header>
        
        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Video Feed -->
            <div class="lg:col-span-2">
                <div class="video-container">
                    <img id="video-feed" src="/video_feed" alt="Video Feed" 
                         class="w-full rounded-2xl">
                    
                    <!-- Overlay Status -->
                    <div id="overlay-status" class="absolute top-4 left-4 px-4 py-2 rounded-full text-white font-semibold status-badge looking-good">
                        <span id="status-icon">‚úÖ</span>
                        <span id="status-text">Initializing...</span>
                    </div>
                </div>
                
                <!-- Instructions -->
                <div class="glass-card rounded-xl p-4 mt-4">
                    <h3 class="font-semibold text-lg mb-2">üìã Instructions</h3>
                    <ul class="text-gray-300 text-sm space-y-1">
                        <li>‚Ä¢ Keep your face visible in the camera</li>
                        <li>‚Ä¢ Look directly at the screen to avoid flags</li>
                        <li>‚Ä¢ Looking away for more than 1.5 seconds will trigger a flag</li>
                        <li>‚Ä¢ Head movements and eye gaze are both tracked</li>
                    </ul>
                </div>
            </div>
            
            <!-- Stats Panel -->
            <div class="space-y-4">
                <!-- Current Status Card -->
                <div class="glass-card rounded-xl p-6">
                    <h3 class="font-semibold text-lg mb-4">üìä Current Status</h3>
                    
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Direction:</span>
                            <span id="direction" class="font-medium">-</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Looking Away:</span>
                            <span id="looking-away-duration" class="font-medium">0.0s</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">üì± Phone:</span>
                            <span id="phone-status" class="font-medium">-</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Total Flags:</span>
                            <span id="total-flags" class="font-bold text-2xl text-red-400">0</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400">Phone Flags:</span>
                            <span id="phone-flags" class="font-bold text-orange-400">0</span>
                        </div>
                    </div>
                </div>
                
                <!-- Flag Counter -->
                <div id="flag-counter" class="glass-card rounded-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold text-lg">üö© Flag History</h3>
                        <button onclick="resetFlags()" 
                                class="px-3 py-1 bg-red-500 hover:bg-red-600 rounded-lg text-sm transition-colors">
                            Reset
                        </button>
                    </div>
                    
                    <div id="flag-list" class="space-y-2 max-h-64 overflow-y-auto">
                        <p class="text-gray-500 text-sm">No flags yet. Keep looking at the screen!</p>
                    </div>
                </div>
                
                <!-- Calibration Card -->
                <div class="glass-card rounded-xl p-6">
                    <h3 class="font-semibold text-lg mb-3">üéØ Calibration</h3>
                    <p class="text-gray-300 text-sm mb-3">
                        Si la d√©tection est incorrecte, recalibrez en regardant l'√©cran normalement.
                    </p>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-400 text-sm">Pitch offset:</span>
                        <span id="pitch-offset" class="font-mono text-sm">0.0¬∞</span>
                    </div>
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-gray-400 text-sm">Status:</span>
                        <span id="calibration-status" class="text-sm">-</span>
                    </div>
                    <button onclick="recalibrate()" 
                            class="w-full px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg text-sm transition-colors font-medium">
                        üîÑ Recalibrer
                    </button>
                </div>
                
                <!-- Tips Card -->
                <div class="glass-card rounded-xl p-6">
                    <h3 class="font-semibold text-lg mb-3">üí° Tips</h3>
                    <ul class="text-gray-300 text-sm space-y-2">
                        <li>üîÜ Ensure good lighting on your face</li>
                        <li>üìè Sit at a comfortable distance</li>
                        <li>üéØ Position camera at eye level</li>
                        <li>üëì Remove glasses if causing issues</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Alert Sound (optional) -->
    <audio id="alert-sound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleQAA" type="audio/wav">
    </audio>
    
    <script>
        let lastFlagCount = 0;
        let previousFlags = [];
        
        // Update status periodically
        function updateStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    // Update direction
                    document.getElementById('direction').textContent = data.direction || '-';
                    
                    // Update looking away duration
                    const duration = data.looking_away_duration || 0;
                    document.getElementById('looking-away-duration').textContent = duration.toFixed(1) + 's';
                    
                    // Update total flags
                    document.getElementById('total-flags').textContent = data.total_flags;
                    
                    // Update phone status
                    const phoneStatus = document.getElementById('phone-status');
                    if (data.phone_detected) {
                        phoneStatus.textContent = 'üö® DETECTED!';
                        phoneStatus.classList.add('text-orange-400');
                        phoneStatus.classList.remove('text-green-400');
                    } else {
                        phoneStatus.textContent = '‚úÖ None';
                        phoneStatus.classList.add('text-green-400');
                        phoneStatus.classList.remove('text-orange-400');
                    }
                    
                    // Update phone flags
                    document.getElementById('phone-flags').textContent = data.phone_flags || 0;
                    
                    // Update overlay status
                    const overlay = document.getElementById('overlay-status');
                    const statusIcon = document.getElementById('status-icon');
                    const statusText = document.getElementById('status-text');
                    
                    overlay.classList.remove('looking-good', 'looking-away', 'no-face');
                    
                    if (data.status === 'no_face') {
                        overlay.classList.add('no-face');
                        statusIcon.textContent = '‚ö†Ô∏è';
                        statusText.textContent = 'No Face Detected';
                    } else if (data.is_looking_away) {
                        overlay.classList.add('looking-away');
                        statusIcon.textContent = '‚ùå';
                        statusText.textContent = 'Looking Away!';
                    } else {
                        overlay.classList.add('looking-good');
                        statusIcon.textContent = '‚úÖ';
                        statusText.textContent = 'Looking at Screen';
                    }
                    
                    // Update flag list if new flags
                    if (data.total_flags > lastFlagCount) {
                        updateFlagList(data.flags);
                        // Play alert sound
                        try {
                            document.getElementById('alert-sound').play();
                        } catch (e) {}
                        lastFlagCount = data.total_flags;
                    }
                    
                    // Update calibration info
                    const pitchOffset = data.pitch_offset || 0;
                    document.getElementById('pitch-offset').textContent = pitchOffset.toFixed(1) + '¬∞';
                    document.getElementById('calibration-status').textContent = 
                        data.calibrated ? '‚úÖ Calibr√©' : '‚è≥ En cours...';
                })
                .catch(err => console.error('Error fetching status:', err));
        }
        
        function updateFlagList(flags) {
            const flagList = document.getElementById('flag-list');
            
            if (flags.length === 0) {
                flagList.innerHTML = '<p class="text-gray-500 text-sm">No flags yet. Keep looking at the screen!</p>';
                return;
            }
            
            flagList.innerHTML = flags.slice().reverse().map((flag, index) => `
                <div class="flag-item flex items-center justify-between bg-red-500/20 rounded-lg p-3 border border-red-500/30">
                    <div>
                        <span class="text-red-400 font-medium">üö© Flag #${flags.length - index}</span>
                        <p class="text-sm text-gray-400">${flag.reason}</p>
                    </div>
                    <div class="text-right">
                        <span class="text-sm text-gray-300">${flag.time}</span>
                        <p class="text-xs text-gray-500">${flag.duration}</p>
                    </div>
                </div>
            `).join('');
        }
        
        function resetFlags() {
            fetch('/reset_flags')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        lastFlagCount = 0;
                        document.getElementById('total-flags').textContent = '0';
                        document.getElementById('flag-list').innerHTML = 
                            '<p class="text-gray-500 text-sm">No flags yet. Keep looking at the screen!</p>';
                    }
                });
        }
        
        function recalibrate() {
            fetch('/recalibrate')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('calibration-status').textContent = '‚è≥ En cours...';
                        document.getElementById('pitch-offset').textContent = '0.0¬∞';
                    }
                });
        }
        
        // Update every 500ms
        setInterval(updateStatus, 500);
        
        // Initial update
        updateStatus();
    </script>
</body>
</html>
